<!doctype html>
<html>
	<head>
		<meta content="IE=edge" http-equiv="X-UA-Compatible">
		<meta charset="utf-8">
		<meta content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" name="viewport">
		<meta name="theme-color" content="#000000">

		<title>Mandala alt</title>

		<link rel="stylesheet" href="/stylesheets/controls.css" type="text/css">

	</head>

	<body class="canvas canvas_mandala-alt canvas_mandala-alt_index">
		<div class="canvas_mandala">
	<main id="main">
		<canvas id="background"></canvas>
		<canvas id="canvas"></canvas>
	</main>
</div>

<div class="controls">
	<p>
		<label for="sectors">Sectors</label>
		<input type="range" id="sectors" name="sectors"
			min="4" max="30" step="1" value="16">
		<output name="sectorsLabel" id="sectorsLabel">16</output>
	</p>
	<p>
		<label for="mirror">Mirror</label>
		<input type="checkbox" id="mirror" name="mirror" checked>
	</p>
	<p>
		<labek for="color">Color</labek>
		<input type="color" id="color" name="color" value="#ffffff">
	</p>
	<p>
		<label for="clear">Clear canvas</label>
		<button id="clear" name="clear">Clear</button>
	</p>
</div>

<script type="text/javascript">
'use strict'

var main = document.getElementById('main'),
	canvas = document.getElementById('canvas'),
	ctx = canvas.getContext('2d'),
	background = document.getElementById('background'),
	bgctx = background.getContext('2d')

var ratio = window.devicePixelRatio
var width = 600 < window.innerWidth ? 600 : window.innerWidth

canvas.width = canvas.height = background.width = background.height = width * ratio
canvas.style.width = canvas.style.height = background.style.width = background.style.height = width + "px"
ctx.scale(ratio, ratio)

var opts = {
	sectors: 16,
	angle: (360 / 16) * (Math.PI / 180),
	mirror: true,
	color: 'rgba(255,255,255,0.1)'
}

var points = []
var startingX
var startingY

var centerX = width / 2
var centerY = width / 2

function changeSectors(event) {
	if (event) {
		opts.sectors = parseFloat(event.target.value)
	}
	opts.angle = (360 / opts.sectors) * (Math.PI / 180)

	bgctx.save()
	bgctx.fillStyle = 'black'
	bgctx.fillRect(0, 0, canvas.width, canvas.height)
	bgctx.lineWidth = 1
	for (var i = 0; i < opts.sectors; i++) {
		bgctx.translate(canvas.width/2, canvas.height/2)
		bgctx.rotate(opts.angle)
		bgctx.translate(-canvas.width/2, -canvas.height/2)

		bgctx.beginPath()
		bgctx.moveTo(canvas.width/2, canvas.height/2)
		bgctx.lineTo(canvas.width, canvas.height)
		bgctx.strokeStyle = "#333"
		bgctx.stroke()
	}
	bgctx.restore()
	sectorsLabel.value = opts.sectors
}

changeSectors()

function draw() {
	ctx.lineWidth = 0.5
	ctx.lineJoin = ctx.lineCap = 'round'
	ctx.strokeStyle = opts.color

	for (var i = 0; i < opts.sectors; i++) {
		for (var j = 1; j < points.length; j++) {
			var from = rotate(points[j - 1].x, points[j - 1].y, i)
			var to = rotate(points[j].x, points[j].y, i)

			ctx.beginPath()
			ctx.quadraticCurveTo(from.x, from.y, to.x, to.y)
			ctx.stroke()
		}
	}

	if (opts.mirror) {
		for (var i = 0; i < opts.sectors; i++) {
			for (var j = 1; j < points.length; j++) {
				var from = rotate(points[j - 1].x, points[j - 1].y, i)
				var to = rotate(points[j].x, points[j].y, i)

					from.x = Math.abs(from.x - width),
					to.x = Math.abs(to.x - width)

				ctx.beginPath()
				ctx.quadraticCurveTo(from.x, from.y, to.x, to.y)
				ctx.stroke()
			}
		}
	}
}

function hexToRgb(hex) {
	var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex)
	return `rgba(${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}, 0.1)`
}

function rotate(x, y, angle) {
	var cos = Math.cos,
		sin = Math.sin

	var radians = (Math.PI / 180) * ((360 /opts.sectors) * angle)

	var xr = (x - centerX) * cos(radians) - (y - centerY) * sin(radians) + centerX
	var yr = (x - centerX) * sin(radians) + (y - centerY) * cos(radians) + centerY

	return {
		x: xr, 
		y: yr
	}
}

canvas.addEventListener('mousedown', function(event) {
	var x = event.clientX - main.offsetLeft
	var y = event.clientY - main.offsetTop

	this.drawing = true
	startingX = x
	startingY = y
})

canvas.addEventListener('mousemove', function(event) {
	var x = event.clientX - main.offsetLeft
	var y = event.clientY - main.offsetTop

	if (this.drawing) {
		points.push({
			x: x,
			y: y
		})
		draw()
	}
})

canvas.addEventListener('touchstart', function(e) {
	e.preventDefault()
	var x = ((typeof e.targetTouches[0] !== "undefined") ? e.targetTouches[0].pageX : null)
	var y = ((typeof e.targetTouches[0] !== "undefined") ? e.targetTouches[0].pageY : null)

	this.drawing = true
	startingX = x
	startingY = y
})

canvas.addEventListener('touchmove', function(e) {
	e.preventDefault()
	var x = ((typeof e.targetTouches[0] !== "undefined") ? e.targetTouches[0].pageX : null)
	var y = ((typeof e.targetTouches[0] !== "undefined") ? e.targetTouches[0].pageY : null)

	points.push({
		x: x,
		y: y
	})
	draw()
})

document.addEventListener('touchend', function(event) {
	canvas.drawing = false
	points = []
})

document.addEventListener('mouseup', function(event) {
	canvas.drawing = false
	points = []
})

document.getElementById('mirror').addEventListener('change', function(event) {
	if (this.checked) {
		opts.mirror = true
	} else {
		opts.mirror = false
	}
})

document.getElementById('color').addEventListener('change', function(event) {
	opts.color = hexToRgb(this.value)
})

document.getElementById('sectors').addEventListener('change', changeSectors)

document.getElementById('clear').addEventListener('click', function(){
	ctx.clearRect(0, 0, canvas.width, canvas.height)
})

window.addEventListener('resize', function(event) {
	var newWidth = window.innerWidth
	if (newWidth === width) return
	if (newWidth < 600) {
		width = newWidth
		canvas.width = canvas.height = background.width = background.height = newWidth * ratio
		canvas.style.width = canvas.style.height = background.style.width = background.style.height = newWidth + 'px'
		ctx.scale(ratio, ratio)
	} else if (width !== 600) {
		width = newWidth
		canvas.width = canvas.height = background.width = background.height = 600 * ratio
		canvas.style.width = canvas.style.height = background.style.width = background.style.height = '600px'
		ctx.scale(ratio, ratio)
	}
	changeSectors()
})

</script>

	</body>
</html>
